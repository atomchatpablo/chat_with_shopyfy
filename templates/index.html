<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üí¨ Chat con Gemini</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f1f1f1;
      margin: 0;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    #chatbox {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    max-width: 800px;
    height: 500px; /* Altura fija */
    overflow-y: auto; /* Scroll vertical */
    margin: 0 auto 20px auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .msg {
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .user {
      text-align: right;
      color: #1a73e8;
    }

    .bot {
      text-align: left;
      color: #111;
    }

    .bubble {
      background-color: #e0e7ff;
      display: inline-block;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 70%;
    }

    .user .bubble {
      background-color: #cce5ff;
    }

    .bot img {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border-radius: 10px;
    }
    .timestamp {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      text-align: right;
    }

    #input-area {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 10px;
    }

    input {
    flex: 1;
    padding: 12px 15px;
    font-size: 16px;
    border: 2px solid #4a90e2;
    border-radius: 10px;
    }

    button {
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    background-color: #4CAF50;
    color: white;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #45a049;
    }
    .message-image {
    max-width: 500px;
    max-height: 500px;
    border-radius: 10px;
    margin-top: 10px;
    display: block;
    }
  </style>
</head>
<body>

  <h2>üí¨ Chat con BigQuery</h2>
  <div style="max-width: 800px; margin: 0 auto 10px auto;">
    <label for="tabla-selector"><strong>üóÉÔ∏è Seleccionar tabla de BigQuery:</strong></label>
    <select id="tabla-selector" style="width: 100%; padding: 10px; border-radius: 10px; margin-top: 5px;">
      <option value="20250801_autoland">Autoland</option>
      <option value="20250728_jepwe7-10">Shopify Store</option>
    </select>
  </div>
  <div style="max-width: 800px; margin: 10px auto;">

    <label for="prompt-selector"><strong>üß† Seleccionar prompt del sistema:</strong></label>
    <select id="prompt-selector" style="width: 100%; padding: 10px; border-radius: 10px; margin-top: 5px;">
      <option value="[Personalidad]\nEres un asesor de ventas de Autoland, experto en resolver consultas relacionadas a los autos que se tienen disponible.\nTienes un tono profesional pero un amigable. Siempre debes mostrarte predispuesto a ayudar a resolver las consultas del usuario.\n\n[Objetivo]\nTu principal objetivo es conversar con el usuario para poder entender sus gustos y preferencia acerca de nuestros productos.\nDebes persuadirlo de modo tal que quiera avanzar en el conocimiento de algun modelo que hay disponible.\nSi te preguntan porque marcas tienes disponible, puedes revisar en la columna 'make, y a partir de ahi le ofreces el abanico de opciones disponibles actualmente\n\n[Restricciones]\nSolo debes poder hablar de topicos relacionados a Autoland, los autos disponibles y temas comerciales o de preguntas frecuentes.\nSi las preguntas que te hacen no estan relacionadas a topicos comerciales, debes responderle de manera amable que no puedes responder esa pregunta, y que estarias contento de ayudar con otra consulta relacionada a Autoland.\nNo inventes. Siempre verifica la informaci√≥n, por ejemplo, si te preguntan por un modelo en particular, si tienen disponibilidad en alguna ciudad, tu debes validar si el auto se encuentra disponible en esa ciudad. Es sumamente importante brindar respuestas exactas.\nSi se te solicita informacion de un modelo en particular, solo debes brindar informacion de ese modelo, si no tienes disponible ese modelo, le pides disculpas, le comentas que actualmente no cuentan con disponibilidad de ese modelo y le ofreces ayuda con alguna otra consulta.\n\n[Herramientas disponibles]\nTienes disponible la herramienta get_bigquery_data, que la vas a utilizar cada vez que la persona quiera conocer informacion de los autos que tenemos disponibles.\n\n[Herramientas y Datos]\nTu √öNICA fuente de informaci√≥n sobre el inventario de autos es la herramienta `get_bigquery_data`./nDEBES usar esta herramienta OBLIGATORIAMENTE para responder CUALQUIER pregunta del usuario sobre:/n- Disponibilidad de marcas, modelos, o versiones espec√≠ficas./n- Precios (sale_price)./n- Kilometraje (mileage)./n- A√±o (year)./n- Ubicaci√≥n (city)./n- Especificaciones t√©cnicas (transmission, cilindraje)./n- Cantidad de autos en stock o comparaciones.\n\n[Formato de la respuesta]\nTus respuesas deben ser breves, claras y √∫tiles. Utiliza emojis si asi lo consideras necesario. Evit√° textos largos. ¬°Que se entienda r√°pido!  Siempre que te des informacion de un auto debes entregar la informacion que esta dentro de los campos: title, year, sale_price, mileage, url y image_link. Siempre que devuelvas un image_link, debes mostrarlo como texto plano, sin hiperv√≠nculo. Por ejemplo:\n**Imagen:** https://ejemplo.com/imagen.jpg \nNo uses formato Markdown como [link](url) ni pongas la URL entre corchetes o par√©ntesis.\n Solo debe verse como texto plano, para que pueda renderizarse correctamente en HTML.\nSi encontr√°s m√°s de 10 opciones, respond√© con las 3 m√°s relevantes y agreg√° algo como:   üëâ ‚ÄúHay muchas m√°s opciones disponibles. Si quer√©s, te puedo ayudar a elegir la ideal üöóüòâ‚Äù Si no tienes una respuesta especifica a la pregunta del usuario, porque no pudiste encontrar la respuesta, disculpate y pregunta si puedes ayudarlo con algo mas\nEjemplo de esperada:\nEjemplo de respuesta correcta:\nT√≠tulo: MAZDA CX-5 TOURING 2022\nA√±o: 2022\nPrecio de venta: 95,000,000\nKilometraje: 13,000\n\nURL: [ver MAZDA CX-5 TOURING](https://autoland.com.co/vehiculo/...)\nImagen: https://autoland.com.co/imagen.jpg \n\n[Formato de la informacion]Cuando consultes la herramienta get_bigquery_data, recibiras la sigueinte informacion\nvehicle_id: Identificador √∫nico del veh√≠culo.\ntitle: T√≠tulo/nombre del veh√≠culo (Marca, Modelo, Versi√≥n).\nmake: Marca del veh√≠culo (Ej: Mazda).\nyear: A√±o de fabricaci√≥n del veh√≠culo.\nprice: Precio original del veh√≠culo.\nsale_price: Precio de venta actual del veh√≠culo.\nmileage: Kilometraje recorrido por el veh√≠culo.\ntransmission: Tipo de transmisi√≥n del veh√≠culo (Autom√°tica/Manual).\ncilindraje: Cilindrada del motor del veh√≠culo.\nurl: Enlace a la p√°gina del veh√≠culo.\nimage_link: Enlace a la imagen del veh√≠culo.\nserie: Serie o versi√≥n espec√≠fica del modelo.\ntype: Tipo de veh√≠culo (Ej: SUV).\ncity: Ciudad donde se encuentra el veh√≠culo.">
        Prompt - Autos Usados Autoland
      </option>
      <option value="Respond√© como un vendedor experto por WhatsApp. Us√° emojis y manten√© las respuestas cortas, claras y √∫tiles (m√°x. 100 palabras). Mostr√° los datos m√°s relevantes:  üìù nombre  üí≤ precio  üìÑ descripci√≥n corta  üé® variantes (si hay)  üì∏ imagen (si hay)  üîó link directo al productoSi encontr√°s m√°s de 3 resultados, mostr√° solo los 3 m√°s relevantes y dec√≠:   üëâ ‚ÄúHay m√°s opciones disponibles, ¬øquer√©s que te ayude a encontrar la ideal? üòâ‚Äù Nada de texto largo. WhatsApp es directo y visual. Si tienes una url de la imagen, entregala como parte de la respuesta (por lo general se encuentra en la columna image_link) Si no tienes una respuesta especifica a la pregunta del usuario, porque no pudiste encontrar la respuesta, disculpate y pregunta si puedes ayudarlo con algo mas">
        Prompt - Productos Shopify
      </option>
      
    </select>
  </div>


<div id="chatbox"></div>
<div id="input-area">
  <input id="msg" placeholder="Escrib√≠ tu mensaje" />
  <button onclick="enviarMensaje()">Enviar</button>
</div>

<script>
  let chat_history = [];

  function renderMarkdown(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\!(.*?)\((.*?)\)/g, "<img src='$2' alt='$1' class='message-image' />")
      .replace(/\[(.*?)\]\((.*?)\)/g, "<a href='$2' target='_blank'>$1</a>")
      .replace(/\n/g, "<br>");
  }

function renderBotMessageWithImages(content) {
  const messageDiv = document.createElement("div");
  messageDiv.className = "msg bot";

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const imageRegex = /\[.*?\]\((https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif)(?:\?[^\s]*)?)\)|\b(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif)(?:\?[^\s]*)?)/gi;
  const matches = [...content.matchAll(imageRegex)].map(m => m[1] || m[2]).filter(Boolean);


  let lastIndex = 0;
  matches.forEach((url) => {
    const index = content.indexOf(url, lastIndex);

    // Agrega el texto previo como HTML (convertido con renderMarkdown)
    if (index > lastIndex) {
      const text = content.slice(lastIndex, index);
      const span = document.createElement("span");
      span.innerHTML = renderMarkdown(text);
      bubble.appendChild(span);
    }

    // Agrega la imagen
    const img = document.createElement("img");
    img.src = url;
    img.className = "message-image";
    bubble.appendChild(img);

    lastIndex = index + url.length;
  });

  // Agrega el texto final que qued√≥ despu√©s de la √∫ltima imagen (si lo hay)
  const finalText = content.slice(lastIndex);
  if (finalText.trim()) {
    const span = document.createElement("span");
    span.innerHTML = renderMarkdown(finalText);
    bubble.appendChild(span);
  }

  messageDiv.appendChild(bubble);
  const now = new Date().toLocaleTimeString("es-AR", { hour12: false });
  const timestampDiv = document.createElement("div");
  timestampDiv.className = "timestamp";
  timestampDiv.innerText = now;
  bubble.appendChild(timestampDiv);
  document.getElementById("chatbox").appendChild(messageDiv);
}

function enviarMensaje() {
  const input = document.getElementById("msg");
  const mensaje = input.value.trim();
  const tableId = document.getElementById("tabla-selector").value;

  if (!mensaje) return;

  input.value = "";
  input.focus();

  const now = new Date().toLocaleTimeString("es-AR", { hour12: false });
  document.getElementById("chatbox").innerHTML += `
    <div class="msg user">
      <div class="bubble">
        ${mensaje}
        <div class="timestamp">${now}</div>
      </div>
    </div>`;

  fetch("/chat_with_db", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      message: mensaje,
      project_id: "atom-ai-labs-ad1fa",
      dataset_id: "chat_with_web",
      table_id: tableId,
      history_chat: chat_history,
      system_prompt: document.getElementById("prompt-selector").value,
    }),
  })
    .then((res) => res.json())
    .then((data) => {
      chat_history.push({ role: "user", parts: [mensaje] });
      chat_history.push({ role: "model", parts: [data.response] });

      renderBotMessageWithImages(data.response);
      const chatbox = document.getElementById("chatbox");
      chatbox.scrollTop = chatbox.scrollHeight;
    })
    .catch((err) => console.error("Error:", err));
}

  // Escucha tecla Enter
  document.getElementById("msg").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault(); // Evita salto de l√≠nea
      enviarMensaje();
    }
  });
</script>
</body>
</html>
